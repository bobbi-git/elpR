#this script formats multiple RavenX selection tables within sub-directories, saves the selection tables, filters the output by score and random days
# Input requires selection tables that are a max length of 10000 selections, with multiple sites merged into one, and minimum score threshold of 0.53
# Detector output from the data template detector
# NO SITE FOLDERS

#bje37
# 7 April 2023

#Steps
#1) Run RavenX selection tables through this R script (files can be in subfolders)
#2) Concatenate the tables
#3) Filter the saved selection tables by score and length using (keep copies of both the filtered and unfiltered files)


#set working directory
#z <- selection_tables

gunsshot_Selection_Table_Restructure <- function (z)
{

  # install and load necessary packages
  sel_table_struct <- c("plyr","dplyr","ggplot2","bigreadr","openxlsx","stringr","gsubfn","lubridate","filesstrings")
  options(warn = -1)
  for (i in sel_table_struct){
    if (!require(i, quietly = TRUE, character.only = TRUE)){
      install.packages(i)
      library(i)
    }
  }

  setwd(gun_selection_tables)

#### set default names ####
  standard_name_disk <- paste(deployment_name,"_dep",deployment_num,"_d",disk_ID, sep="") # output file names (deployment name, number, disk)
  raw_table_name <-paste(deployment_name,"_dep",deployment_num,"_",Detector,"_p",sub("\\d.","",Detector_ScoreThreshold),"_",sample_rate,"_brut",sep="") #default raw output table name
  filtered_table_name <-  paste(deployment_name,"_dep",deployment_num,"_",Detector,"_p",sub("\\d.","",Filter_ScoreThreshold),"_",sample_rate,"_brut",sep="") # default filtered table name

#### Cross-reference sound files with known errors ####
# this should have been generated by the Sound_Quality_Check r script already
  sound_check <- read.xlsx(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/sound_check/Sound_Check_Reports_",standard_name_disk,".xlsx",sep=""),sheet="Sounds",colNames=TRUE,check.names=FALSE,sep.names = " ") # read in the sound_check file that was created in the first step
  sound_check$'Sound Problems'<-paste(sound_check$`File Duration Check`, sound_check$'File Length Check',sound_check$`Sound Gap Check`,sound_check$"SampleRate", sound_check$"Deployment Notes",sound_check$"Sound Problems", sound_check$`Exclude (y)`,sep = "; ") # concatenate the sound problems into one column
  names(sound_check)[names(sound_check) == 'Current File Name'] <- 'Begin File' #change "begin hour" to "hour"
  sound_problem<-sound_check[c("Begin File", "Sound Problems","Exclude (y/e)")]


#### Read the size and index the selection tables ####
  gun_selection_tables <- '~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/raw'
  setwd(gun_selection_tables)
  file_names<-dir(path=gun_selection_tables,all.files=TRUE,include.dirs=TRUE,recursive = TRUE, pattern=".txt") #index all the files
  file_size<-file_names[sapply(file_names, file.size) > 200] # index only files greater than 200 bytes since those <200 bytes are blank selection tables (the for loop code won't run on empty selection tables)

  # Record empty selection tables (those with less than 200 bytes)
  #file_small <-data.frame("Empty Selection Tables","Deployment","Site","Date","Deployment Name","Detection Score") # create a new dataframe for when there are no empty tables
  file_small<-as.data.frame(file_names[sapply(file_names, file.size) < 200])# lists (identifies) tables with no detections
  if(nrow(file_small) >0){
            file_small$dep <-deployment_num
            colnames(file_small) <- c("Empty Selection Table","Deployment")
            file_small$Site <- substring(sub("_20.*","",file_small$'Empty Selection Table'),4) #NEED TO UPDATE THIS FOR THE CLUSTER SITE NAMES
            file_small$Date <- substr(sub(".*Date_","",file_small$'Empty Selection Table'),start=1,stop=8)
            file_small$Date <- as.POSIXct(file_small$Date,format='%Y%m%d',origin = "1970-01-01",tz="Africa/Brazzaville") # convert format of start date and time to proper data and time format
            file_small$`Deployment Name` <- deployment_name
            file_small$Detection_Score <- Detector_ScoreThreshold
            write.table(file_small, file= paste('~/R/Bobbi_Scripts/Packages/elpR/Files/Empty_Tables/gunshot/Empty_Tables_',raw_table_name,'.txt',sep=""),
                        sep='\t',na="",col.names=TRUE,row.names=FALSE, quote=FALSE, append=FALSE) #save a .csv listing the files with no detections
  }

#### Create new selection tables ####
#Load raw detector output, add new columns and remove columns that are not needed, and save new selection tables into the Processed folder

  for (i in 1:length(file_size)){
    gun_data<-read.table(file_size[i],header=TRUE,sep="\t", check.names=FALSE) #read each table from the 200+ byte list separately
    gun_data_df<-as.data.frame.matrix(gun_data) #save each individual selection table as a data frame
    gun_new<- gun_data_df #[ , -which(names(gun_data_df) %in% c("Delta Time (s)","Delta Freq (Hz)", "Tags", "SID", "Time Check"))] #remove unwanted columns
    #names(gun_new)[names(gun_new) == 'Begin Hour'] <- 'Hour' #change "begin hour" to "hour"
    gun_new$`Begin File` <- basename(gun_new$`Begin Path`) # str_match(gun_new$`Begin Path`,"nn\\d{2}(.*?).wav")[,1]
    gun_new$`File Start DateTime` <- str_extract(gun_new$`Begin File`,"\\d{8}.\\d{6}") #  file start date and time from file name (_YYYYMMDD_HHMMSS)
    gun_new$`File Start DateTime` <- as.POSIXct(gun_new$`File Start DateTime`,format='%Y%m%d_%H%M%S',origin = "1970-01-01",tz="Africa/Brazzaville") #tz = "UTC"
    gun_new$`File Start Date`<-format(as.Date(str_extract(gun_new$'Begin File' ,"\\d{8}.\\d{6}"),"%Y%m%d"),"%m/%d/%Y") # use this for date if you want the file date rather than Raven Begin Date
    gun_new$`Selection Begin DateTime` <- gun_new$`File Start DateTime`+ gun_new$`File Offset (s)` # add File Offset (s)  to calculate selection date-time
    gun_new$`Begin Date`<- as.Date(gun_new$'Selection Begin DateTime',"%Y%m%d",tz="Africa/Brazzaville") # different from File Name Date in that it is the date of the event
    gun_new$`Begin Clock Time` <-format(gun_new$`Selection Begin DateTime`,"%H:%M:%S") # Time of event
    gun_new$`Begin Hour` <- format(as.POSIXct( gun_new$`Begin Clock Time` ,format="%H:%M:%S"),"%H")# hour(gun_new$`Begin Clock Time`)
    gun_new$CFD<-NA #add gunshot coding annotation column
    gun_new$`Gun Type` <- NA
    gun_new$Notes<-NA #add "Notes" column
    gun_new$Analyst<-NA #add "Analyst" column
    gun_new$"Deployment"<-deployment_num # add a deployment number column (change for each deployment)
    gun_new$Score<-as.numeric(round(gun_new$Score,digits = 3)) #round the score to 3 decimal places
    #gun_new$"Site"<-sub("_.*","",gun_new$`Begin File`)# substr(gun_new$"Begin File",1,5) #add column with the Site ID, derived from the file path name
    gun_new$Site <- substr(str_match(gun_new$`Begin File`,"[a-z]{2}\\d{2}[a-z]{1}\\s*(.*?)\\s*_20")[,1],1,
                    nchar(str_match(gun_new$`Begin File`,"[a-z]{2}\\d{2}[a-z]{1}\\s*(.*?)\\s*_20")[,1])-3)
    gun_order<-gun_new[c("Selection", "View", "Channel", "Begin Time (s)", "End Time (s)", "Low Freq (Hz)", "High Freq (Hz)",
                         "Begin Path", "File Offset (s)", "Begin File", "Begin Date","Begin Clock Time","Site", "Begin Hour",
                         "File Start Date", "Score", "CFD","Gun Type","Notes", "Analyst", "Deployment")] #reorder columns
    gun_sort<-gun_order[order(gun_order$"File Offset (s)"),]# sort dataframe by file offset
    # sound problems
    # disk#
    write.table(gun_sort,paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/processed/",file_size[i],sep=""),sep="\t",na="",col.names=TRUE,row.names=FALSE, quote=FALSE, append=FALSE) #save each table with same name into same directory
  }

#### MERGE ALL SELECTION TABLES ####
# WARNING: this step is for selection tables that are not in a site-wise folder structure

  setwd("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/processed/") #so the script jumps into each subfolder
  list_txt = list.files(path="~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/processed/", full.names = TRUE,pattern="*.txt") #make a list of all the files within the subfolder j
  all_txt_df <- lapply(list_txt, function(x) {read.table(file = x, header = T, sep ="\t", check.names=FALSE)})  # Read the files in, assuming tab separator
  merge_df <- do.call("rbind", lapply(all_txt_df, as.data.frame)) # Combine them (the events cross over between sites and cuts off the last site - use the rbind.fill function)
  merge_df<-if(!is.null(merge_df)){merge_df[order(merge_df$"Begin File",merge_df$"File Offset (s)"),]}
  merge_filter <- filter(merge_df,merge_df$"Score">=Filter_ScoreThreshold) #filter the merged table by threshold
  merge_filter$"Selection"<- if(nrow(merge_filter)>0){seq.int(nrow(merge_filter))} #renumber the selections for Raven

  # separate tables into sites
  siteWise_list <- split(merge_filter, f = merge_filter$Site)

#### create directories to receive the processed selection tables by score threshold ####
  # if(!dir.exists(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/p", sub("\\d.","",Filter_ScoreThreshold),sep=""))){
  #   dir.create(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/p",sub("\\d.","",Filter_ScoreThreshold),sep=""))}
  # if(!dir.exists(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/p",sub("\\d.","",Detector_ScoreThreshold),"-p",sub("\\d.","",Filter_ScoreThreshold),"_raw/",sep=""))){
  #   dir.create(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/p",sub("\\d.","",Detector_ScoreThreshold),"-p",sub("\\d.","",Filter_ScoreThreshold),"_raw/",sep=""))}
  # if(!dir.exists(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/raw",sep=""))){
  #   dir.create(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/raw",sep=""))}


  # # filter tables and move them to cooresponding folders in the final folder
  # for (q in 1:length(file_size)){
  #   gun_merged <- read.table(file_size[q],header=TRUE,sep="\t",check.names=FALSE) #read in the merged selection table
  #   gun_sound_table <- if(nrow(gun_merged)>0){
  #     gun_sound <- gun_merged[c("Selection", "View", "Channel", "Begin Time (s)", "End Time (s)", "Low Freq (Hz)", "High Freq (Hz)",
  #                               "Begin Path", "File Offset (s)", "Begin File", "Site", "Begin Date", "Begin Clock Time","Begin Hour",
  #                               "File Start Date", "Score", "CFD", "Gun Type", "Notes", "Analyst", "Deployment"
  #                               )] #"Sound Problems","Call Criteria","Disk"
  #     gun_th<-filter(gun_sound,gun_sound$"Score">=Filter_ScoreThreshold) #filter the merged table by score threshold
  #     write.table(gun_th,file=paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/p",
  #                                        sub("\\d.","",Detector_ScoreThreshold),"-p",sub("\\d.","",Filter_ScoreThreshold),"_raw/", # folder name
  #                                        substr(file_size[q],1,nchar(file_size[q])-7),sub("\\d.","p",Detector_ScoreThreshold),"-p",sub("\\d.","",Filter_ScoreThreshold),"_raw.txt",sep=""), # file name
  #                 sep="\t",na="",col.names=TRUE,row.names=FALSE,quote=FALSE) # save all other detections < threshold
  #   } #if this doesn't run initially because it can't find the file, check that the "Begin Path" in the selection tables match
  # }

#### save filtered and raw tables####
  for (m in seq(siteWise_list)){
    write.table(siteWise_list[[m]],file=paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/",standard_name_disk,"_",names(siteWise_list)[[m]],"_",Detector,"_p",
                                              sub("\\d.","",Filter_ScoreThreshold),"_",sample_rate,"_brut.txt",sep=""),
                sep="\t",na="",col.names=TRUE,row.names=FALSE, quote=FALSE) #save tables
  }

  # # move the remaining selection tables to the final p2_raw folder
  # for (h in 1:length(file_names)){
  #   file.move(paste("~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/processed/",file_names[h],sep=""),
  #             "~/R/Bobbi_Scripts/Packages/elpR/Files/Selection_Tables/gunshot/final/raw/",overwrite = TRUE)
  # }
  #

#### Summarize sampling effort and # detections per site day ####

  gun_sounds <- sound_check[!(sound_check$`Exclude (y/e)` %in% "y"),] # exclude sound files marked to exclude ("y")
  gun_sounds2 <- gun_sounds[c("Site", "Begin File", "File Duration (s)", "Duration Minutes","Exclude (y/e)","Sound Problems", "File Path")]
  names(gun_sounds2)[names(gun_sounds2) == "File Path"] <- "Begin Path"
  gun_sounds2$Date <- format(as.Date(str_extract(gun_sounds2$'Begin File' ,"\\d{8}.\\d{6}"),"%Y%m%d"),"%m/%d/%Y")

  # list sites
  proj_sites <- as.data.frame(read.table(paste('~/R/Bobbi_Scripts/Packages/elpR/Files/sites/',sites,sep=""),header=FALSE,sep="\t", check.names=FALSE))
  gun_det_sites <- data.frame(proj_sites) # list the sites
  colnames(gun_det_sites) <- "Site" # rename the site column

  # summarize gunshots
  det_files_Detector_ScoreThreshold_Site_Date_summary <- merge_filter %>% group_by(`Begin File`,Site,`Begin Date`) %>% tally()
  det_files_Detector_ScoreThreshold_Site_summary <- merge_filter %>% group_by(Site) %>% tally()

  # summarize sounds
  gun_sound_sites_sum <- aggregate(gun_sounds$`Duration Hours`, by = list(Site=gun_sounds$Site),FUN=sum, na.rm = TRUE) # duration of recording (hrs) per site

  # merge detections and sound files
  gun_sound_dets <- merge(gun_sounds2,det_files_Detector_ScoreThreshold_Site_Date_summary,all.x=T)
  gun_sound_site_dets <- merge(gun_sound_sites_sum,det_files_Detector_ScoreThreshold_Site_summary,all.x=T)
  colnames(gun_sound_site_dets) <- c("Site","Duration (Hrs)","Number of Detections")
  # if duration > 0 and # dets is NA, change from NA to 0

  wb <- loadWorkbook(file = paste("~/R/Bobbi_Scripts/Packages/elpR/Files/sound_check/Sound_Check_Reports_",standard_name_disk,".xlsx",sep=""))
  if("Gunshot Detector Summaries" %in% names(wb)){
    removeWorksheet(wb, "Gunshot Detector Summaries")
    saveWorkbook(wb, paste("~/R/Bobbi_Scripts/Packages/elpR/Files/sound_check/Sound_Check_Reports_",standard_name_disk,".xlsx",sep=""),overwrite=TRUE)
  }
  addWorksheet(wb, sheetName = "Gunshot Detector Summaries",tabColour='blue')
  writeData(wb, sheet = "Gunshot Detector Summaries", x = gun_sound_site_dets)
  saveWorkbook(wb,paste("~/R/Bobbi_Scripts/Packages/elpR/Files/sound_check/Sound_Check_Reports_",standard_name_disk,".xlsx",sep=""),returnValue=FALSE,overwrite=TRUE)


# #### Create 'Zero-days' Sound Selection Table from Sound Check Table INSTEAD of numevents file ####
#   sounds_det <- sound_check[!(sound_check$`Exclude (y/e)` %in% "y"),] # dataframe of sound files that excludes bad sounds
#   sounds_det$`Current File Start DateTime` <- convertToDateTime(sounds_det$`Current File Start DateTime`,origin = "1900-01-01")
#   sounds_det$Date <- as.Date(sounds_det$`Current File Start DateTime`)
#   file_dets <- merge_filter %>% group_by(`Begin File`) %>% tally()# sum number of detections per sound file
#   check_dets <- merge(sounds_det,file_dets,by=c("Begin File"),all.x=T)# merge the number of detection per sound file with the sound check file
#   names(check_dets)[names(check_dets) == 'n'] <- 'Number of Gunshot Detections'
#   check_dets$`Number of Gunshot Detections`[is.na(check_dets$`Number of Gunshot Detections`)] <-0
#   # Time to midnight
#   # Time from midnight
#   # If duration exceeds time to midnight, then it's measured in time past midnight
#   No_dets_table <- subset(check_dets,(`Number of Gunshot Detections`%in% "0"))  # isolate table to only days with 0 detections
#
#   # create new table based on sound_dets to summarize # minutes per day of recorder
#   No_dets_table$Selection <- seq(1:nrow(No_dets_table))
#   No_dets_table$View = "Spectrogram"
#   No_dets_table$Channel = 1
#   No_dets_table$`Begin Time (s)` = 20
#   No_dets_table$`End Time (s)` = 60
#   No_dets_table$`Low Freq (Hz)` = 10
#   No_dets_table$`High Freq (Hz)` = 1000
#   names(No_dets_table)[names(No_dets_table) == 'File Path'] <- 'Begin Path'
#   No_dets_table$`File Offset (s)`= 20
#   No_dets_table$'Begin Date' <- format(as.Date(str_extract(No_dets_table$'Begin File' ,"\\d{8}.\\d{6}"),"%Y%m%d"),"%m/%d/%Y")
#   No_dets_table$`File Start DateTime` <- as.POSIXct(str_extract(No_dets_table$`Begin File`,"\\d{8}.\\d{6}"),format='%Y%m%d_%H%M%S',origin = "1970-01-01",tz="Africa/Brazzaville")  #  file start date and time from file name (_YYYYMMDD_HHMMSS)
#   No_dets_table$`File Start Date`<-format(as.Date(str_extract(No_dets_table$'Begin File' ,"\\d{8}.\\d{6}"),"%Y%m%d"),"%m/%d/%Y")
#   No_dets_table$`Begin Clock Time` <-format(No_dets_table$`File Start DateTime`,"%H:%M:%S") # Time of event
#   No_dets_table$`Begin Hour` <- format(as.POSIXct( No_dets_table$`Begin Clock Time` ,format="%H:%M:%S"),"%H")# hour(gun_new$`Begin Clock Time`)
#   No_dets_table$Site <- sub("_.*","",No_dets_table$`Begin File`)
#   No_dets_table$Score <- "NA"
#   No_dets_table$CFD <- "NA"
#   No_dets_table$`Gun Type` <- "NA"
#   No_dets_table$Notes <- paste("No detections on this sound file at the score threshold of",Filter_ScoreThreshold,sep=" ")
#   No_dets_table$Analyst <- "NA"
#   No_dets_table$Deployment <- deployment_num
#   No_dets_table_new<-No_dets_table[c("Selection", "View", "Channel", "Begin Time (s)", "End Time (s)", "Low Freq (Hz)", "High Freq (Hz)",
#                        "Begin Path", "File Offset (s)", "Begin File", "Begin Date","Begin Clock Time","Site", "Begin Hour",
#                        "File Start Date", "Score", "CFD","Gun Type","Notes", "Analyst", "Deployment")] #reorder columns
#   write.table(No_dets_table_new,file=paste("~/R/Bobbi_Scripts/Packages/elpR/Files/zero_days_SSTs/gunshot/",filtered_table_name,"_No_Dets.txt",sep=""),
#               sep="\t",na="",col.names=TRUE,row.names=FALSE,quote=FALSE)


  # #### Create 'Zero-days' Sound Selection Table from NumEvents INSTEAD of the sound check file ####
  # setwd(gun_num_events)
  # dets <- list.files(gun_num_events, full.names = TRUE)# list all the num events tables and merge them into one table
  # dets_table <- lapply(dets, function(x) {read.table(file = x, header = T, sep ="\t", check.names=FALSE)})
  # dets_table <- do.call("rbind", lapply(dets_table, as.data.frame))
  # No_dets_table <- subset(dets_table,(`Num Events`%in% "0"))  # isolate table to only days with 0 detections
  # No_dets_table$`Begin File` <- basename(No_dets_table$`Sound Files`) # extract the sound file name from the path
  # No_dets_table$Selection <- seq(1:nrow(No_dets_table))
  # No_dets_table$View = "Spectrogram"
  # No_dets_table$Channel = 1
  # No_dets_table$`Begin Time (s)` = 20
  # No_dets_table$`End Time (s)` = 60
  # No_dets_table$`Low Freq (Hz)` = 10
  # No_dets_table$`High Freq (Hz)` = 1000
  # names(No_dets_table)[names(No_dets_table) == 'Sound Files'] <- 'Begin Path'
  # No_dets_table$`File Offset (s)`= 20
  # No_dets_table$'Begin Date' <- format(as.Date(str_extract(No_dets_table$'Begin File' ,"\\d{8}.\\d{6}"),"%Y%m%d"),"%m/%d/%Y")
  # No_dets_table$`File Start DateTime` <- as.POSIXct(str_extract(No_dets_table$`Begin File`,"\\d{8}.\\d{6}"),format='%Y%m%d_%H%M%S',origin = "1970-01-01",tz="Africa/Brazzaville")  #  file start date and time from file name (_YYYYMMDD_HHMMSS)
  # No_dets_table$`File Start Date`<-format(as.Date(str_extract(No_dets_table$'Begin File' ,"\\d{8}.\\d{6}"),"%Y%m%d"),"%m/%d/%Y")
  # No_dets_table$`Begin Clock Time` <-format(No_dets_table$`File Start DateTime`,"%H:%M:%S") # Time of event
  # No_dets_table$`Begin Hour` <- format(as.POSIXct( No_dets_table$`Begin Clock Time` ,format="%H:%M:%S"),"%H")# hour(gun_new$`Begin Clock Time`)
  # No_dets_table$Site <- sub("_.*","",No_dets_table$`Begin File`)
  # No_dets_table$Score <- "NA"
  # No_dets_table$CFD <- "NA"
  # No_dets_table$`Gun Type` <- "NA"
  # No_dets_table$Notes <- paste("No detections on this sound file at the score threshold of",Filter_ScoreThreshold,sep=" ")
  # No_dets_table$Analyst <- "NA"
  # No_dets_table$Deployment <- deployment_num
  # No_dets_table_new<-No_dets_table[c("Selection", "View", "Channel", "Begin Time (s)", "End Time (s)", "Low Freq (Hz)", "High Freq (Hz)",
  #                                    "Begin Path", "File Offset (s)", "Begin File", "Begin Date","Begin Clock Time","Site", "Begin Hour",
  #                                    "File Start Date", "Score", "CFD","Gun Type","Notes", "Analyst", "Deployment")] #reorder columns
  # write.table(No_dets_table_new,file=paste("~/R/Bobbi_Scripts/Packages/elpR/Files/zero_days_SSTs/gunshot/",filtered_table_name,"_No_Dets.txt",sep=""),sep="\t",na="",col.names=TRUE,row.names=FALSE,quote=FALSE)
  #

  #### plot to detector summaries (total detections by sound file) ####

  setwd("~/R/Bobbi_Scripts/Packages/elpR/Files/num_events/gunshot")
  sum_date_dets <-  merge_filter %>%
    group_by(Site,`Begin Date`) %>%
    dplyr::summarize(num_events = n())
  sum_date_dets$`Begin Date` <- as.Date(sum_date_dets$`Begin Date`,format="%Y-%m-%d")
  det_sum <- sum_date_dets[order(sum_date_dets$Site,sum_date_dets$`Begin Date`),]
  det_sum_plot <- ggplot(det_sum, aes(x = `Begin Date`, y = `num_events`, colour = Site)) +
    geom_point(show.legend = FALSE)+
    scale_y_continuous(trans='log10')+
    facet_wrap( ~ Site)
  ggsave(plot = det_sum_plot,paste(filtered_table_name,"_det_sum_plot.png",sep=""),width =10, height =10 )
  # print(det_sum_p2_plot)

#### Summarize number of detections per site/day ####
  # sound_dates <- aggregate(`Duration Minutes`~Site+Date,data=sounds_det,FUN=sum) # summarize total duration of recording for each site and date
  # dets_dates <- merge_filter %>% group_by(Site,`Begin Date`) %>% tally()
  # colnames(dets_dates) <- c("Site","Date","Number of Gunshot Detections")
  # dets_table2 <- merge(sound_dates,dets_dates,by=c("Site","Date"),all.x=T)# cross reference the detections with sound_check
  # dets_table2$`Number of Gunshot Detections`[is.na(dets_table2$`Number of Gunshot Detections`)] <-0

  }
